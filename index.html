<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>üéÖ –ú–∞–≥—ñ—á–Ω–∏–π –õ–∏—Å—Ç –°–∞–Ω—Ç—ñ - WebAR</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/aframe/build/aframe-ar.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: none; /* –ó–∞–ø–æ–±—ñ–≥–∞—î –∑—É–º—É —Ç–∞ —Å–∫—Ä–æ–ª—É –Ω–∞ –º–æ–±—ñ–ª—å–Ω–æ–º—É */
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            overflow: hidden;
            height: 100vh;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó */
        .instructions {
            position: absolute;
            top: 10px;
            left: 0;
            width: 100%;
            text-align: center;
            color: white;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 0 0 20px 20px;
            max-height: 20vh;
            overflow-y: auto;
        }

        .instructions h2 {
            margin-bottom: 5px;
            font-size: clamp(1em, 4vw, 1.2em);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .instructions p {
            margin: 3px 0;
            font-size: clamp(0.8em, 3vw, 0.9em);
            opacity: 0.9;
            line-height: 1.3;
        }

        /* –ö–Ω–æ–ø–∫–∏ */
        .controls {
            position: absolute;
            bottom: 15px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 10px;
            z-index: 1000;
            padding: 0 10px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: clamp(10px, 4vw, 12px) clamp(15px, 5vw, 20px);
            background: linear-gradient(45deg, #FF3366, #FF6B6B);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: clamp(14px, 4vw, 16px);
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 51, 102, 0.4);
            transition: all 0.3s ease;
            min-width: 80px;
            touch-action: manipulation; /* –ü–æ–∫—Ä–∞—â—É—î touch –Ω–∞ –º–æ–±—ñ–ª—å–Ω–æ–º—É */
        }

        .control-btn:hover, .control-btn:active {
            transform: scale(1.05);
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        /* –ó–∞–≥—Ä—É–∑–∫–∞ */
        #loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 10000;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            width: clamp(30px, 8vw, 40px);
            height: clamp(30px, 8vw, 40px);
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è */
        .message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 15px 20px;
            border-radius: 15px;
            text-align: center;
            z-index: 10000;
            display: none;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 2px solid #FFD700;
            font-size: clamp(14px, 4vw, 16px);
        }

        /* –Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å—É */
        #listeningIndicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            z-index: 10000;
            display: none;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 20px;
            border: 3px solid #FF3366;
            max-width: 90%;
        }

        .pulse-ring {
            width: 80px;
            height: 80px;
            border: 3px solid #FF3366;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
            margin: 0 auto 15px;
        }

        .mic-icon {
            font-size: clamp(24px, 6vw, 30px);
            margin-bottom: 10px;
        }

        @keyframes pulse {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        /* –ê–¥–∞–ø—Ç–∞—Ü—ñ—è –¥–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö –µ–∫—Ä–∞–Ω—ñ–≤ */
        @media (max-width: 480px) {
            .instructions { 
                top: 5px; 
                padding: 8px; 
                max-height: 25vh; 
            }
            .controls { 
                bottom: 10px; 
                gap: 8px; 
                padding: 0 5px; 
            }
            .control-btn { 
                min-width: 70px; 
                font-size: 14px; 
            }
            #loading { padding: 10px; }
            .message { padding: 12px 15px; }
            #listeningIndicator { padding: 15px; }
        }

        /* –î–ª—è –ª–∞–Ω–¥—à–∞—Ñ—Ç–Ω–æ—ó –æ—Ä—ñ—î–Ω—Ç–∞—Ü—ñ—ó –Ω–∞ –º–æ–±—ñ–ª—å–Ω–æ–º—É */
        @media (orientation: landscape) and (max-height: 500px) {
            .instructions { 
                position: fixed; 
                top: 0; 
                max-height: 15vh; 
                font-size: 0.8em; 
            }
            .controls { bottom: 5px; gap: 5px; }
            .control-btn { padding: 8px 12px; font-size: 12px; }
        }

        /* –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –µ–ª–µ–º–µ–Ω—Ç–∏ –¥–ª—è VR/AR —Ñ–æ–∫—É—Å—É */
        a-scene:focus {
            outline: none;
        }
    </style>
</head>
<body>
    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
    <div id="loading">
        <div class="spinner"></div>
        <h2>–ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Ä—ñ–∑–¥–≤—è–Ω—É –º–∞–≥—ñ—é... ‚ú®</h2>
        <p>–ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –º—ñ–∫—Ä–æ—Ñ–æ–Ω —Ç–∞ –∫–∞–º–µ—Ä—É</p>
    </div>

    <!-- –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó -->
    <div class="instructions">
        <h2>üéÖ –ú–∞–≥—ñ—á–Ω–∏–π –õ–∏—Å—Ç –°–∞–Ω—Ç—ñ</h2>
        <p>üé§ –ù–∞—Ç–∏—Å–Ω–∏ "–ì–æ–≤–æ—Ä–∏—Ç–∏" —Ç–∞ —Å–∫–∞–∂–∏ –ø–æ–±–∞–∂–∞–Ω–Ω—è —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é</p>
        <p>‚ùÑÔ∏è –°–º—ñ—Ö–∞–π—Å—è - —Å–Ω—ñ–∂–∏–Ω–∫–∏ –±—É–¥—É—Ç—å —Ç–∞–Ω—Ü—é–≤–∞—Ç–∏!</p>
    </div>

    <!-- –Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å—É -->
    <div id="listeningIndicator">
        <div class="pulse-ring"></div>
        <div class="mic-icon">üé§</div>
        <p>–°–ª—É—Ö–∞—é —Ç–≤–æ—ó –ø–æ–±–∞–∂–∞–Ω–Ω—è...</p>
        <p style="font-size: 0.8em; opacity: 0.8;">–ì–æ–≤–æ—Ä–∏ —á—ñ—Ç–∫–æ —Ç–∞ –≥–æ–ª–æ—Å–Ω–æ!</p>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∏ –∫–µ—Ä—É–≤–∞–Ω–Ω—è -->
    <div class="controls">
        <button class="control-btn" onclick="toggleVoiceRecognition()">üé§ –ì–æ–≤–æ—Ä–∏—Ç–∏</button>
        <button class="control-btn" onclick="clearAllText()">üßπ –û—á–∏—Å—Ç–∏—Ç–∏</button>
        <button class="control-btn" onclick="showHelp()">‚ùì –î–æ–ø–æ–º–æ–≥–∞</button>
    </div>

    <!-- AR –°—Ü–µ–Ω–∞ -->
    <a-scene 
        embedded 
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
        renderer="logarithmicDepthBuffer: true; colorManagement: true; antialias: true;"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: true;"
    >
        <!-- –ö–∞–º–µ—Ä–∞ -->
        <a-camera gps-camera rotation-reader></a-camera>
        
        <!-- –û—Å–≤—ñ—Ç–ª–µ–Ω–Ω—è -->
        <a-light type="ambient" color="#4455AA" intensity="0.6"></a-light>
        <a-light type="directional" position="1 2 1" intensity="0.8" color="#FFEEDD"></a-light>

        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ç–µ–∫—Å—Ç—É -->
        <a-entity id="textContainer"></a-entity>

        <!-- –°–∏—Å—Ç–µ–º–∞ —Å–Ω—ñ–∂–∏–Ω–æ–∫ -->
        <a-entity id="snowSystem"></a-entity>

        <!-- –ú–∞–≥—ñ—á–Ω—ñ –µ—Ñ–µ–∫—Ç–∏ -->
        <a-entity id="magicEffects"></a-entity>
    </a-scene>

    <script>
        class MagicSantaLetter {
            constructor() {
                this.isListening = false;
                this.recognition = null;
                this.snowflakes = [];
                this.floatingTexts = [];
                this.audioContext = null;
                this.analyser = null;
                this.mediaStream = null; // –î–ª—è –∞—É–¥—ñ–æ-—Å—Ç—Ä—ñ–º—É
                
                this.init();
            }

            async init() {
                // –ß–µ–∫–∞—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ü–µ–Ω–∏
                await this.waitForSceneLoad();
                
                // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ —Å–∏—Å—Ç–µ–º–∏
                await this.initAudioStream(); // –¢—ñ–ª—å–∫–∏ –∞—É–¥—ñ–æ, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—É –∑ AR.js
                this.initSpeechRecognition();
                this.initSnowSystem();
                this.initAudioAnalysis();
                
                // –•–æ–≤–∞—î–º–æ –∑–∞–≥—Ä—É–∑–∫—É
                setTimeout(() => {
                    document.getElementById('loading').style.display = 'none';
                    this.showMessage('–í—ñ—Ç–∞—é! –ì–æ–≤–æ—Ä–∏ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –¥–æ –°–∞–Ω—Ç–∏! üéÖ');
                }, 2000);
            }

            waitForSceneLoad() {
                return new Promise((resolve) => {
                    const scene = document.querySelector('a-scene');
                    if (scene.hasLoaded) {
                        resolve();
                    } else {
                        scene.addEventListener('loaded', resolve);
                    }
                });
            }

            async initAudioStream() {
                try {
                    // –¢—ñ–ª—å–∫–∏ –∞—É–¥—ñ–æ, AR.js –æ–±—Ä–æ–±–∏—Ç—å –≤—ñ–¥–µ–æ –æ–∫—Ä–µ–º–æ
                    this.mediaStream = await navigator.mediaDevices.getUserMedia({ 
                        audio: true 
                    });
                    console.log('–ê—É–¥—ñ–æ-—Å—Ç—Ä—ñ–º —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ');
                } catch (err) {
                    console.error('–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –∞—É–¥—ñ–æ:', err);
                    this.showMessage('–î–æ–∑–≤–æ–ª—å –¥–æ—Å—Ç—É–ø –¥–æ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞ üì§');
                }
            }

            initSpeechRecognition() {
                if (!('webkitSpeechRecognition' in window)) {
                    this.showMessage('–¢–≤—ñ–π –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –≥–æ–ª–æ—Å–æ–≤–∏–π –≤–≤—ñ–¥ üò¢ –°–ø—Ä–æ–±—É–π Chrome –Ω–∞ Android');
                    return;
                }

                this.recognition = new webkitSpeechRecognition();
                this.recognition.continuous = true;
                this.recognition.interimResults = true;
                this.recognition.lang = 'uk-UA';
                this.recognition.maxAlternatives = 3;

                this.recognition.onstart = () => {
                    this.isListening = true;
                    this.showListeningIndicator();
                    this.createMagicEffect();
                };

                this.recognition.onresult = (event) => {
                    let bestTranscript = '';
                    let highestConfidence = 0;

                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const result = event.results[i];
                        
                        if (result.isFinal) {
                            for (let j = 0; j < result.length; j++) {
                                const alternative = result[j];
                                if (alternative.confidence > highestConfidence) {
                                    highestConfidence = alternative.confidence;
                                    bestTranscript = alternative.transcript;
                                }
                            }
                        }
                    }

                    if (bestTranscript && highestConfidence > 0.1) {
                        this.processUkrainianText(bestTranscript, highestConfidence);
                    }
                };

                this.recognition.onerror = (event) => {
                    console.log('–ü–æ–º–∏–ª–∫–∞ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è:', event.error);
                    
                    if (event.error === 'not-allowed') {
                        this.showMessage('–î–æ–∑–≤–æ–ª—å –¥–æ—Å—Ç—É–ø –¥–æ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞ –≤ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö –±—Ä–∞—É–∑–µ—Ä–∞ üì±');
                    } else if (event.error === 'network') {
                        this.showMessage('–ü–µ—Ä–µ–≤—ñ—Ä –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç—É üåê');
                    }
                    
                    this.hideListeningIndicator();
                };

                this.recognition.onend = () => {
                    this.isListening = false;
                    this.hideListeningIndicator();
                };
            }

            processUkrainianText(text, confidence) {
                console.log('–†–æ–∑–ø—ñ–∑–Ω–∞–Ω–æ:', text, '–í–ø–µ–≤–Ω–µ–Ω—ñ—Å—Ç—å:', confidence);
                
                let improvedText = this.improveUkrainianText(text);
                
                this.createFloatingText(improvedText);
                
                this.celebrateTextCreation();
                
                this.showRecognitionFeedback(improvedText, confidence);
            }

            improveUkrainianText(text) {
                const corrections = {
                    '—Å–∞–Ω—Ç–æ': '—Å–∞–Ω—Ç–∞',
                    '–¥–æ–±—Ä–∏–π –¥–µ–Ω—å': '–¥–æ–±—Ä–∏–π —Å–∞–Ω—Ç–æ',
                    '–¥–æ–±—Ä–∏–π –≤–µ—á—ñ—Ä': '–¥–æ–±—Ä–∏–π —Å–∞–Ω—Ç–æ',
                    '–ø–æ–¥–∞—Ä—É–Ω–æ—á–æ–∫': '–ø–æ–¥–∞—Ä—É–Ω–æ–∫',
                    '–ª—è–ª—å–∫–∞': '–ª—è–ª—å–∫—É',
                    '–º–∞—à–∏–Ω–∫–∞': '–º–∞—à–∏–Ω–∫—É',
                    '–ª–µ–≥–æ': '–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä',
                    '–∫–Ω–∏–≥–∞': '–∫–Ω–∏–∂–∫—É',
                    '–≤–µ–¥–º–µ–¥–∏–∫': '–≤–µ–¥–º–µ–¥–∏–∫–∞',
                    '–ø–ª–∞–Ω—à–µ—Ç': '–ø–ª–∞–Ω—à–µ—Ç',
                    '—Ä–æ–ª–∏–∫–∏': '—Ä–æ–ª–∏–∫–∏',
                    '–≤–µ–ª–æ—Å–∏–ø–µ–¥–∞': '–≤–µ–ª–æ—Å–∏–ø–µ–¥'
                };

                let improved = text.toLowerCase();
                
                Object.keys(corrections).forEach(wrong => {
                    const right = corrections[wrong];
                    improved = improved.replace(new RegExp(wrong, 'gi'), right);
                });

                improved = improved.charAt(0).toUpperCase() + improved.slice(1);
                
                return improved;
            }

            showRecognitionFeedback(text, confidence) {
                const confidenceColor = confidence > 0.7 ? '#4CAF50' : 
                                      confidence > 0.4 ? '#FF9800' : '#F44336';
                
                const feedback = document.createElement('div');
                feedback.className = 'message';
                feedback.innerHTML = `
                    <div style="margin-bottom: 8px;">üó£Ô∏è –†–æ–∑–ø—ñ–∑–Ω–∞–Ω–æ:</div>
                    <div style="font-size: 1.1em; margin: 8px 0; color: #FFD700;">"${text}"</div>
                    <div style="font-size: 0.9em; color: ${confidenceColor}">
                        –Ø–∫—ñ—Å—Ç—å: ${Math.round(confidence * 100)}%
                    </div>
                `;
                feedback.style.display = 'block';
                
                document.body.appendChild(feedback);
                
                setTimeout(() => {
                    if (feedback.parentNode) {
                        feedback.parentNode.removeChild(feedback);
                    }
                }, 2500);
            }

            initSnowSystem() {
                for (let i = 0; i < 25; i++) {
                    this.createSnowflake();
                }
            }

            createSnowflake() {
                const snowflake = document.createElement('a-entity');
                
                const x = (Math.random() - 0.5) * 4;
                const y = Math.random() * 3 + 1;
                const z = -2 - Math.random() * 3;
                const fallDuration = 3000 + Math.random() * 4000;
                
                snowflake.setAttribute('position', `${x} ${y} ${z}`);
                snowflake.setAttribute('geometry', {
                    primitive: 'plane',
                    width: 0.08,
                    height: 0.08
                });
                snowflake.setAttribute('material', {
                    color: '#FFFFFF',
                    transparent: true,
                    opacity: 0.7 + Math.random() * 0.3,
                    shader: 'flat'
                });
                
                // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ—á–∞—Ç–∫–æ–≤—É –ø–æ–∑–∏—Ü—ñ—é –¥–ª—è —Ü–∏–∫–ª—ñ—á–Ω–æ–≥–æ –ø–∞–¥—ñ–Ω–Ω—è
                snowflake.setAttribute('data-initial-y', y);
                
                // –ê–Ω—ñ–º–∞—Ü—ñ—è –ø–∞–¥—ñ–Ω–Ω—è
                snowflake.setAttribute('animation__fall', {
                    property: 'position',
                    to: `${x} ${y - 5} ${z}`,
                    dur: fallDuration,
                    loop: true,
                    easing: 'easeInQuad'
                });
                
                // –û–±–µ—Ä—Ç–∞–Ω–Ω—è
                snowflake.setAttribute('animation__rotation', {
                    property: 'rotation',
                    to: '0 0 360',
                    dur: 2000 + Math.random() * 3000,
                    loop: true
                });

                document.querySelector('#snowSystem').appendChild(snowflake);
                this.snowflakes.push(snowflake);
            }

            initAudioAnalysis() {
                if (!this.mediaStream) return;
                
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.analyser = this.audioContext.createAnalyser();
                    
                    const source = this.audioContext.createMediaStreamSource(this.mediaStream);
                    source.connect(this.analyser);
                    this.startAudioAnalysis();
                } catch (e) {
                    console.log('Web Audio API –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è');
                }
            }

            startAudioAnalysis() {
                const bufferLength = this.analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                
                const analyze = () => {
                    this.analyser.getByteFrequencyData(dataArray);
                    
                    const volume = dataArray.reduce((a, b) => a + b) / dataArray.length / 256;
                    
                    this.updateSnowflakes(volume);
                    
                    requestAnimationFrame(analyze);
                };
                
                analyze();
            }

            updateSnowflakes(volume) {
                this.snowflakes.forEach((snowflake) => {
                    const posStr = snowflake.getAttribute('position');
                    if (!posStr) return;
                    const pos = posStr.split(' ').map(Number);
                    const initialY = parseFloat(snowflake.getAttribute('data-initial-y')) || pos[1];
                    
                    // –®–≤–∏–¥–∫—ñ—Å—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤—ñ –≥—É—á–Ω–æ—Å—Ç—ñ
                    const speed = Math.max(1000, 4000 / (volume * 10 + 1));
                    
                    // –û–Ω–æ–≤–ª—é—î–º–æ dur, –∞–ª–µ –Ω–µ to, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –¥—Ä–µ–π—Ñ—É; to –ª–∏—à–∞—î–º–æ —Ñ—ñ–∫—Å–æ–≤–∞–Ω–∏–º –≤—ñ–¥ initial
                    snowflake.setAttribute('animation__fall', {
                        dur: speed,
                        loop: true
                    });
                    
                    const scale = Math.min(2, 0.8 + volume * 2);
                    snowflake.setAttribute('scale', `${scale} ${scale} 1`);
                });
            }

            createFloatingText(text) {
                const textEntity = document.createElement('a-entity');
                
                const x = (Math.random() - 0.5) * 2;
                const y = Math.random() * 1 + 0.5;
                const z = -2;
                
                textEntity.setAttribute('position', `${x} ${y} ${z}`);
                textEntity.setAttribute('text', {
                    value: text,
                    color: this.getRandomColor(),
                    align: 'center',
                    width: 3,
                    wrapCount: 20
                });

                textEntity.setAttribute('animation__scale', {
                    property: 'scale',
                    from: '0 0 0',
                    to: '1 1 1',
                    dur: 1500,
                    easing: 'easeOutElastic'
                });

                textEntity.setAttribute('animation__float', {
                    property: 'position',
                    to: `${x + 0.1} ${y + 0.05} ${z}`,
                    dur: 6000,
                    easing: 'easeInOutSine',
                    dir: 'alternate',
                    loop: true
                });

                document.querySelector('#textContainer').appendChild(textEntity);
                this.floatingTexts.push(textEntity);
            }

            getRandomColor() {
                const colors = ['#FF6B6B', '#4ECDC4', '#FFE66D', '#6B48FF', '#FF8E53', '#00FFAA'];
                return colors[Math.floor(Math.random() * colors.length)];
            }

            celebrateTextCreation() {
                this.danceSnowflakes();
                this.createMagicSparks();
            }

            danceSnowflakes() {
                this.snowflakes.forEach(snowflake => {
                    const posStr = snowflake.getAttribute('position');
                    if (!posStr) return;
                    const pos = posStr.split(' ').map(Number);
                    const offsetX = (Math.random() - 0.5) * 0.3;
                    const offsetY = (Math.random() - 0.2) * 0.3;
                    
                    snowflake.setAttribute('animation__dance', {
                        property: 'position',
                        to: `${pos[0] + offsetX} ${pos[1] + offsetY} ${pos[2]}`,
                        from: 'auto',
                        dur: 600,
                        dir: 'alternate',
                        loop: true
                    });
                });

                setTimeout(() => {
                    this.snowflakes.forEach(snowflake => {
                        snowflake.removeAttribute('animation__dance');
                    });
                }, 1500);
            }

            createMagicSparks() {
                for (let i = 0; i < 6; i++) {
                    this.createSpark();
                }
            }

            createSpark() {
                const spark = document.createElement('a-entity');
                const x = (Math.random() - 0.5) * 1.5;
                const y = Math.random() * 0.8 + 0.3;
                
                spark.setAttribute('position', `${x} ${y} -1.8`);
                spark.setAttribute('geometry', {
                    primitive: 'sphere',
                    radius: 0.015
                });
                spark.setAttribute('material', {
                    color: this.getRandomColor(),
                    shader: 'flat'
                });
                spark.setAttribute('animation__scale', {
                    property: 'scale',
                    from: '1 1 1',
                    to: '0 0 0',
                    dur: 1000
                });
                spark.setAttribute('animation__move', {
                    property: 'position',
                    to: `${x + (Math.random() - 0.5) * 0.2} ${y + Math.random() * 0.3} -1.8`,
                    dur: 1000
                });

                document.querySelector('#magicEffects').appendChild(spark);
                
                setTimeout(() => {
                    if (spark.parentNode) {
                        spark.parentNode.removeChild(spark);
                    }
                }, 1000);
            }

            createMagicEffect() {
                const ring = document.createElement('a-entity');
                ring.setAttribute('position', '0 0.5 -1');
                ring.setAttribute('geometry', {
                    primitive: 'ring',
                    radiusInner: 0.05,
                    radiusOuter: 0.1
                });
                ring.setAttribute('material', {
                    color: '#FFD700',
                    shader: 'flat',
                    opacity: 0.8
                });
                ring.setAttribute('animation__scale', {
                    property: 'scale',
                    from: '1 1 1',
                    to: '3 3 3',
                    dur: 800
                });
                ring.setAttribute('animation__fade', {
                    property: 'material.opacity',
                    to: 0,
                    dur: 800
                });

                document.querySelector('a-scene').appendChild(ring);
                
                setTimeout(() => {
                    if (ring.parentNode) {
                        ring.parentNode.removeChild(ring);
                    }
                }, 800);
            }

            showListeningIndicator() {
                document.getElementById('listeningIndicator').style.display = 'block';
            }

            hideListeningIndicator() {
                document.getElementById('listeningIndicator').style.display = 'none';
            }

            showMessage(text) {
                const message = document.createElement('div');
                message.className = 'message';
                message.textContent = text;
                message.style.display = 'block';
                document.body.appendChild(message);
                
                setTimeout(() => {
                    if (message.parentNode) {
                        message.parentNode.removeChild(message);
                    }
                }, 3000);
            }

            startListening() {
                if (this.recognition && !this.isListening) {
                    try {
                        this.recognition.start();
                    } catch (error) {
                        this.showMessage('–ù–∞—Ç–∏—Å–Ω–∏ "–ì–æ–≤–æ—Ä–∏—Ç–∏" —â–µ —Ä–∞–∑!');
                    }
                }
            }

            stopListening() {
                if (this.recognition && this.isListening) {
                    this.recognition.stop();
                }
            }

            clearAllText() {
                this.floatingTexts.forEach(text => {
                    if (text.parentNode) {
                        text.parentNode.removeChild(text);
                    }
                });
                this.floatingTexts = [];
                
                this.showMessage('–õ–∏—Å—Ç –æ—á–∏—â–µ–Ω–æ! –ú–æ–∂–Ω–∞ –ø–∏—Å–∞—Ç–∏ –∑–Ω–æ–≤—É ‚ú®');
            }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –¥–ª—è –∫–Ω–æ–ø–æ–∫
        let santaApp;

        function toggleVoiceRecognition() {
            if (!santaApp) return;
            
            if (santaApp.isListening) {
                santaApp.stopListening();
            } else {
                santaApp.startListening();
            }
        }

        function clearAllText() {
            if (santaApp) {
                santaApp.clearAllText();
            }
        }

        function showHelp() {
            const helpText = `üéÖ –î–û–ü–û–ú–û–ì–ê –î–õ–Ø –ú–ê–õ–ï–ù–¨–ö–û–ì–û –î–†–£–ó–ê üéÖ

üé§ –Ø–∫ –≥–æ–≤–æ—Ä–∏—Ç–∏:
‚Ä¢ –¢—Ä–∏–º–∞–π —Ç–µ–ª–µ—Ñ–æ–Ω —è–∫ –º—ñ–∫—Ä–æ—Ñ–æ–Ω
‚Ä¢ –ì–æ–≤–æ—Ä–∏ —á—ñ—Ç–∫–æ —Ç–∞ –≥–æ–ª–æ—Å–Ω–æ
‚Ä¢ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –ø—Ä–æ—Å—Ç—ñ —Å–ª–æ–≤–∞

üí¨ –ü—Ä–∏–∫–ª–∞–¥–∏ —Ñ—Ä–∞–∑:
‚Ä¢ "–î–æ–±—Ä–∏–π –°–∞–Ω—Ç–∞"
‚Ä¢ "–Ø —Ö–æ—á—É –≤–µ–¥–º–µ–¥–∏–∫–∞"
‚Ä¢ "–ü–æ–¥–∞—Ä—É–π –º–µ–Ω—ñ –ª—è–ª—å–∫—É"
‚Ä¢ "–ü—Ä–∏–Ω–µ—Å–∏ –∫–Ω–∏–∂–∫—É"
‚Ä¢ "–Ø —Ö–æ—á—É –º–∞—à–∏–Ω–∫—É"

‚ùÑÔ∏è –ß–∞—Ä—ñ–≤–Ω—ñ—Å—Ç—å:
‚Ä¢ –°–º—ñ—Ö–∞–π—Å—è - —Å–Ω—ñ–∂–∏–Ω–∫–∏ —Ç–∞–Ω—Ü—é—é—Ç—å!
‚Ä¢ –ì–æ–≤–æ—Ä–∏ –≥–æ–ª–æ—Å–Ω—ñ—à–µ - —Å–Ω—ñ–∂–∏–Ω–∫–∏ —Å—Ç–∞—é—Ç—å –±—ñ–ª—å—à–∏–º–∏!
‚Ä¢ –î–∏–≤–∏—Å—å, —è–∫ —Å–ª–æ–≤–∞ –ª—ñ—Ç–∞—é—Ç—å —É –ø–æ–≤—ñ—Ç—Ä—ñ!

üéÑ –í–µ—Å–µ–ª–∏—Ö —Å–≤—è—Ç!`;
            
            alert(helpText);
        }

        // –ó–∞–ø—É—Å–∫ –¥–æ–¥–∞—Ç–∫—É –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
        window.addEventListener('DOMContentLoaded', () => {
            santaApp = new MagicSantaLetter();
        });

        // –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫
        window.addEventListener('error', (event) => {
            console.error('–ü–æ–º–∏–ª–∫–∞:', event.error);
            document.getElementById('loading').innerHTML = `
                <h2>–©–æ—Å—å –ø—ñ—à–ª–æ –Ω–µ —Ç–∞–∫ üò¢</h2>
                <p>–û–Ω–æ–≤—ñ—Ç—å —Å—Ç–æ—Ä—ñ–Ω–∫—É —Ç–∞ —Å–ø—Ä–æ–±—É–π—Ç–µ –∑–Ω–æ–≤—É</p>
                <button class="control-btn" onclick="location.reload()" style="margin-top: 20px;">üîÑ –û–Ω–æ–≤–∏—Ç–∏</button>
            `;
        });

        // –û–±—Ä–æ–±–∫–∞ –æ—Ä—ñ—î–Ω—Ç–∞—Ü—ñ—ó –¥–ª—è –º–æ–±—ñ–ª—å–Ω–æ–≥–æ
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                window.scrollTo(0, 1); // –§—ñ–∫—Å –¥–ª—è iOS viewport
            }, 100);
        });
    </script>
</body>
</html>
