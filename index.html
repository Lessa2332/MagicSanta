<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>‚úã Finger Fun AR - –†–æ–∑–≤–∏—Ç–æ–∫ –º–æ—Ç–æ—Ä–∏–∫–∏ –¥–ª—è –¥—ñ—Ç–µ–π</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { overflow: hidden; font-family: 'Arial', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; }
    #container { position: relative; width: 100vw; height: 100vh; }
    #ar-container { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; }
    canvas { display: block; width: 100%; height: 100%; }
    #ui { position: absolute; top: 20px; left: 20px; right: 20px; z-index: 100; text-align: center; }
    #status { background: rgba(0,0,0,0.7); padding: 10px; border-radius: 10px; font-size: 18px; margin-bottom: 10px; }
    #exercises { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
    button { background: linear-gradient(135deg, #ff6b6b, #ee5a24); color: white; border: none; padding: 15px; border-radius: 50px; font-size: 24px; cursor: pointer; transition: transform 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    button:hover { transform: scale(1.1); }
    button.active { background: linear-gradient(135deg, #4ecdc4, #44a08d); }
    #feedback { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); padding: 20px; border-radius: 15px; text-align: center; font-size: 20px; display: none; animation: pulse 1s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 0.7; } 50% { opacity: 1; } }
    #instructions { position: absolute; top: 100px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); padding: 15px; border-radius: 10px; text-align: center; max-width: 80%; }
    #langBtn { position: absolute; top: 20px; right: 20px; background: #6c5ce7; padding: 10px; border-radius: 20px; z-index: 100; }
  </style>
</head>
<body>
  <div id="container">
    <div id="ar-container"></div>
    <canvas id="canvas"></canvas>
    <div id="snowflakes"></div>
    
    <button id="langBtn">üá∫üá¶ UA</button>
    
    <div id="ui">
      <div id="status">üëã –ü—Ä–∏–≤—ñ—Ç! –ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ —Å—Ç—ñ–ª –¥–ª—è AR –≤–ø—Ä–∞–≤ ‚úã</div>
      <div id="exercises">
        <button id="exercise1" title="–°—Ç–∏—Å–∫–∞–π –∫—É–ª–∞–∫">‚úä</button>
        <button id="exercise2" title="–†–æ–∑–≤–µ–¥–∏ –ø–∞–ª—å—Ü—ñ">üñêÔ∏è</button>
        <button id="exercise3" title="–¢–æ—Ä–∫–Ω–∏ –ø–∞–ª—å—Ü–µ–º">üëÜ</button>
        <button id="exercise4" title="–ö–æ–ª–æ –ø–∞–ª—å—Ü–µ–º">‚Ü∫Ô∏è</button>
      </div>
    </div>
    
    <div id="instructions">
      <p>1. –ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ —Ä—ñ–≤–Ω—É –ø–æ–≤–µ—Ä—Ö–Ω—é (—Å—Ç—ñ–ª) üéØ</p>
      <p>2. –û–±–µ—Ä–∏ –≤–ø—Ä–∞–≤—É –∫–Ω–æ–ø–∫–æ—é üì±</p>
      <p>3. –í–∏–∫–æ–Ω—É–π –∂–µ—Å—Ç —Ä—É–∫–æ—é –ø–µ—Ä–µ–¥ –∫–∞–º–µ—Ä–æ—é ‚úã</p>
      <p>4. –Ø–∫—â–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ ‚Äî –∑'—è–≤–∏—Ç—å—Å—è ‚ù§Ô∏è —Ç–∞ –∑–≤—É–∫! üéµ</p>
    </div>
    
    <div id="feedback"></div>
  </div>

  <!-- CDN –ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ -->
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.3/dist/mindar-image.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.169.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <script>
    // –ú–æ–≤–∏
    const translations = {
      en: {
        status: { initial: 'üëã Hello! Point camera at table for AR exercises ‚úã', drawing: '‚úçÔ∏è Performing exercise...', done: '‚ú® Great! Try next ‚úã', clear: 'üåü Reset!' },
        instructions: { step1: '1. Point camera at flat surface üéØ', step2: '2. Select exercise üì±', step3: '3. Do gesture with hand ‚úã', step4: '4. Correct = ‚ù§Ô∏è & sound! üéµ' },
        exercises: { 1: 'Fist ‚úä', 2: 'Spread fingers üñêÔ∏è', 3: 'Point finger üëÜ', 4: 'Circle finger ‚Ü∫Ô∏è' },
        feedback: { success: 'Well done! ‚ù§Ô∏è', fail: 'Try again! üòä' }
      },
      uk: {
        status: { initial: 'üëã –ü—Ä–∏–≤—ñ—Ç! –ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ —Å—Ç—ñ–ª –¥–ª—è AR –≤–ø—Ä–∞–≤ ‚úã', drawing: '‚úçÔ∏è –í–∏–∫–æ–Ω—É–π –≤–ø—Ä–∞–≤—É...', done: '‚ú® –ß—É–¥–æ–≤–æ! –°–ø—Ä–æ–±—É–π –Ω–∞—Å—Ç—É–ø–Ω—É ‚úã', clear: 'üåü –°–∫–∏–Ω—É—Ç–∏!' },
        instructions: { step1: '1. –ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ —Ä—ñ–≤–Ω—É –ø–æ–≤–µ—Ä—Ö–Ω—é üéØ', step2: '2. –û–±–µ—Ä–∏ –≤–ø—Ä–∞–≤—É üì±', step3: '3. –í–∏–∫–æ–Ω—É–π –∂–µ—Å—Ç —Ä—É–∫–æ—é ‚úã', step4: '4. –ü—Ä–∞–≤–∏–ª—å–Ω–æ = ‚ù§Ô∏è —Ç–∞ –∑–≤—É–∫! üéµ' },
        exercises: { 1: '–°—Ç–∏—Å–∫–∞–π –∫—É–ª–∞–∫ ‚úä', 2: '–†–æ–∑–≤–µ–¥–∏ –ø–∞–ª—å—Ü—ñ üñêÔ∏è', 3: '–¢–æ—Ä–∫–Ω–∏ –ø–∞–ª—å—Ü–µ–º üëÜ', 4: '–ö–æ–ª–æ –ø–∞–ª—å—Ü–µ–º ‚Ü∫Ô∏è' },
        feedback: { success: '–ú–æ–ª–æ–¥–µ—Ü—å! ‚ù§Ô∏è', fail: '–°–ø—Ä–æ–±—É–π —â–µ! üòä' }
      }
    };
    let currentLang = 'uk';

    // AR + Three
    let mindarThree, scene, camera, renderer;
    let hands, videoElement, currentExercise = 0;
    let heartEmoji, feedbackDiv = document.getElementById('feedback');
    let audioContext; // –î–ª—è –∑–≤—É–∫—ñ–≤

    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è AR
    function initAR() {
      mindarThree = new MindARThree({ container: document.getElementById('ar-container') });
      const { renderer: r, scene: s, camera: c } = mindarThree;
      renderer = r; scene = s; camera = c;

      // –û—Å–≤—ñ—Ç–ª–µ–Ω–Ω—è
      scene.add(new THREE.AmbientLight(0xffffff, 0.6));
      const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
      dirLight.position.set(10, 10, 5);
      scene.add(dirLight);

      // –°–µ—Ä–¥–µ—á–∫–æ –µ–º–æ–¥–∑—ñ (3D)
      const heartGeo = new THREE.SphereGeometry(0.2, 16, 16);
      const heartMat = new THREE.MeshBasicMaterial({ color: 0xff1493 });
      heartEmoji = new THREE.Mesh(heartGeo, heartMat);
      heartEmoji.visible = false;
      scene.add(heartEmoji);

      // –ó–∞–ø—É—Å–∫ AR
      mindarThree.start(() => {
        renderer.setAnimationLoop(animate);
      });
    }

    // –ê–Ω—ñ–º–∞—Ü—ñ—è
    function animate() {
      if (heartEmoji.visible) {
        heartEmoji.rotation.y += 0.05;
        heartEmoji.position.y = Math.sin(Date.now() * 0.005) * 0.1 + 0.5;
      }
      renderer.render(scene, camera);
    }

    // –û–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∏–π MediaPipe
    function initHands() {
      hands = new Hands({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
      });
      hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 0, // Lite –¥–ª—è —à–≤–∏–¥–∫–æ—Å—Ç—ñ
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
      });
      hands.onResults(onResults);
    }

    // –ö–∞–º–µ—Ä–∞ (–∑–∞–¥–Ω—è)
    async function startCamera() {
      try {
        videoElement = document.getElementById('video');
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment', width: 640, height: 480 }
        });
        videoElement.srcObject = stream;

        const camera = new Camera(videoElement, {
          onFrame: async () => await hands.send({ image: videoElement }),
          width: 320, height: 240 // –ù–∏–∑—å–∫–∞ –¥–ª—è –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó
        });
        await camera.start();
      } catch (err) {
        console.error('Camera error:', err);
        // Fallback —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'user', width: 640, height: 480 }
        });
        videoElement.srcObject = stream;
        // ... –∞–Ω–∞–ª–æ–≥—ñ—á–Ω–æ
      }
    }

    // –û–±—Ä–æ–±–∫–∞ –∂–µ—Å—Ç—ñ–≤
    function onResults(results) {
      const t = translations[currentLang];
      if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
        const landmarks = results.multiHandLandmarks[0];
        let correct = false;

        switch (currentExercise) {
          case 1: // –ö—É–ª–∞–∫: –≤—Å—ñ –ø–∞–ª—å—Ü—ñ –∑—ñ–≥–Ω—É—Ç—ñ
            correct = landmarks[8].y > landmarks[6].y && landmarks[12].y > landmarks[10].y && landmarks[16].y > landmarks[14].y && landmarks[20].y > landmarks[18].y;
            break;
          case 2: // –†–æ–∑–≤–µ–¥–∏ –ø–∞–ª—å—Ü—ñ: –∫—É—Ç–∏ > 60¬∞
            const angle1 = Math.abs(landmarks[8].x - landmarks[12].x) * 180;
            const angle2 = Math.abs(landmarks[12].x - landmarks[16].x) * 180;
            const angle3 = Math.abs(landmarks[16].x - landmarks[20].x) * 180;
            correct = angle1 > 60 && angle2 > 60 && angle3 > 60;
            break;
          case 3: // –¢–æ—Ä–∫–Ω–∏ –ø–∞–ª—å—Ü–µ–º: –≤–∫–∞–∑—ñ–≤–Ω–∏–π + –≤–µ–ª–∏–∫–∏–π –±–ª–∏–∑—å–∫–æ
            const dist = Math.sqrt(Math.pow(landmarks[8].x - landmarks[4].x, 2) + Math.pow(landmarks[8].y - landmarks[4].y, 2));
            correct = dist < 0.05;
            break;
          case 4: // –ö–æ–ª–æ: —Ä—É—Ö –≤–∫–∞–∑—ñ–≤–Ω–æ–≥–æ –ø–æ –∫–æ–ª—É (—à–≤–∏–¥–∫—ñ—Å—Ç—å)
            // –ü—Ä–æ—Å—Ç–∏–π: –≤—ñ–¥—Å—Ç–∞–Ω—å –≤—ñ–¥ —Ü–µ–Ω—Ç—Ä—É —Ä—É–∫–∏
            const centerX = (landmarks[0].x + landmarks[9].x) / 2;
            const centerY = (landmarks[0].y + landmarks[9].y) / 2;
            const distToCenter = Math.sqrt(Math.pow(landmarks[8].x - centerX, 2) + Math.pow(landmarks[8].y - centerY, 2));
            correct = distToCenter > 0.1 && distToCenter < 0.2; // "–ö–æ–ª–æ" –∑–æ–Ω–∞
            break;
        }

        if (correct) {
          document.getElementById('status').textContent = t.status.done;
          showFeedback(t.feedback.success);
          playSuccessSound();
          heartEmoji.position.set(0, 0.5, 0);
          heartEmoji.visible = true;
          setTimeout(() => heartEmoji.visible = false, 2000);
          currentExercise = 0; // –°–∫–∏–Ω—å –≤–ø—Ä–∞–≤—É
        } else {
          document.getElementById('status').textContent = t.status.drawing;
        }
      } else {
        if (currentExercise) document.getElementById('status').textContent = t.status.drawing;
      }
    }

    // –§—ñ–¥–±–µ–∫
    function showFeedback(msg) {
      feedbackDiv.textContent = msg;
      feedbackDiv.style.display = 'block';
      setTimeout(() => feedbackDiv.style.display = 'none', 3000);
    }

    // –ê—É–¥—ñ–æ –∫–ª—ñ–∫ (Web Audio API, –±–µ–∑ —Ñ–∞–π–ª—ñ–≤)
    function playSuccessSound() {
      if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.5);
    }

    function playClickSound() {
      if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
      gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.1);
    }

    // –ü–æ–¥—ñ—ó –∫–Ω–æ–ø–æ–∫
    document.addEventListener('DOMContentLoaded', () => {
      initAR();
      initHands();
      startCamera();

      document.getElementById('exercise1').onclick = () => { currentExercise = 1; playClickSound(); updateButtons(1); };
      document.getElementById('exercise2').onclick = () => { currentExercise = 2; playClickSound(); updateButtons(2); };
      document.getElementById('exercise3').onclick = () => { currentExercise = 3; playClickSound(); updateButtons(3); };
      document.getElementById('exercise4').onclick = () => { currentExercise = 4; playClickSound(); updateButtons(4); };

      document.getElementById('langBtn').onclick = () => {
        currentLang = currentLang === 'uk' ? 'en' : 'uk';
        document.getElementById('langBtn').textContent = currentLang === 'uk' ? 'üá∫üá∏ EN' : 'üá∫üá¶ UA';
        updateUI();
        playClickSound();
      };

      function updateButtons(active) {
        document.querySelectorAll('#exercises button').forEach((btn, idx) => {
          btn.classList.toggle('active', idx + 1 === active);
        });
      }

      function updateUI() {
        const t = translations[currentLang];
        document.getElementById('status').textContent = t.status.initial;
        // –û–Ω–æ–≤–∏—Ç–∏ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó (—è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ)
      }
    });
  </script>
</body>
</html>
